connections:
  - name: "conn1"
    dsn: "{{db_dsn}}"
  - name: "conn2"
    dsn: "{{db_dsn}}"
queries:
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "DROP TABLE IF EXISTS users"
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "CREATE TABLE `users` (`id` int(11) NOT NULL AUTO_INCREMENT, `title` varchar(255) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci"
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "INSERT INTO users(title) VALUES('user1'),('user2')"
  - connection: "conn1"
    type: "exec"
    sql: "BEGIN"
    message_before: "start"
    message_after: "stop"
  - connection: "conn1"
    type: "query"
    sql: "select * from users FOR UPDATE"
    message_before: "start"
    message_after: "stop"
  - connection: "conn2"
    type: "query"
    sql: "select * from users FOR UPDATE"
    message_before: "start: oh wait"
    message_after: "stop: other transaction commited"
    async: true
  - connection: "conn1"
    type: "exec"
    sql: "COMMIT"
    message_before: "now commit"
    message_after: "stop commit"
    sleep: 3