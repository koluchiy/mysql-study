connections:
  - name: "conn1"
    dsn: "{{db_dsn}}"
  - name: "conn2"
    dsn: "{{db_dsn}}"
queries:
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "DROP TABLE IF EXISTS users"
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "CREATE TABLE `users` (`id` int(11) NOT NULL AUTO_INCREMENT, `title` varchar(255) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci"
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "INSERT INTO users(title) VALUES('user1'),('user2')"
  - connection: "conn1"
    type: "exec"
    sql: "BEGIN"
    message_before: "start"
    message_after: "stop"
  - connection: "conn1"
    type: "query"
    sql: "select * from users"
    message_before: "select all users"
    message_after: "we see two users"
  - connection: "conn2"
    type: "exec"
    sql: "BEGIN"
  - connection: "conn2"
    type: "query"
    sql: "INSERT INTO users(title) VALUES('user3')"
    message_before: "insert new user but not commit"
  - connection: "conn1"
    type: "query"
    sql: "select * from users"
    message_before: "select all users"
    message_after: "we still see two users"
  - connection: "conn2"
    type: "exec"
    sql: "COMMIT"
    message_before: "commit transaction with insert"
  - connection: "conn1"
    type: "query"
    sql: "select * from users"
    message_before: "select all users"
    message_after: "now we still see two users because of REPEATABLE-READ isolation level"
  - connection: "conn1"
    type: "exec"
    sql: "COMMIT"
    message_before: "commit transaction"
  - connection: "conn1"
    type: "query"
    sql: "select * from users"
    message_before: "select all users"
    message_after: "in new transaction we see third user"
  - connection: "conn1"
    type: "exec"
    sql: "BEGIN"
    message_before: "start new transaction"
  - connection: "conn1"
    type: "query"
    sql: "INSERT INTO users(title) VALUES('user4')"
    message_before: "insert new user"
  - connection: "conn1"
    type: "query"
    sql: "select * from users"
    message_before: "select all users"
    message_after: "we see fourth user that we add, but not commit yet"
