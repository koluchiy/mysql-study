connections:
  - name: "conn1"
    dsn: "{{db_dsn}}"
  - name: "conn2"
    dsn: "{{db_dsn}}"
queries:
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "DROP TABLE IF EXISTS users"
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "CREATE TABLE `users` (`id` int(11) NOT NULL AUTO_INCREMENT, user_id int(11) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_general_ci"
  - connection: "conn1"
    type: "exec"
    message_before: "prepare table"
    sql: "INSERT INTO users(user_id) VALUES(5),(20),(200)"
  - connection: "conn1"
    type: "exec"
    sql: "BEGIN"
  - connection: "conn1"
    type: "query"
    sql: "select * from users where user_id=15 FOR UPDATE"
    message_before: "start"
    message_after: "stop"
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (25)"
    message_before: "try insert something in another transaction"
    message_after: "stop: deadline exceeded"
    timeout: 5
  - connection: "conn1"
    type: "exec"
    sql: "COMMIT"
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (100)"
    message_before: "try insert something in another transaction"
    message_after: "now success"
  - connection: "conn1"
    type: "exec"
    sql: "COMMIT"
  - connection: "conn1"
    type: "exec"
    sql: "create index user_id on users(user_id);"
    message_before: "now create index on user_id field"
  - connection: "conn1"
    type: "exec"
    sql: "BEGIN"
  - connection: "conn1"
    type: "query"
    sql: "select * from users where user_id=20 FOR UPDATE"
    message_before: "mysql set GAP lock on [5, 100)"
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (90)"
    message_before: "try insert something in another transaction"
    timeout: 5
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (5)"
    message_before: "try insert something in another transaction"
    timeout: 5
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (50)"
    message_before: "try insert something in another transaction"
    timeout: 5
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (4)"
    message_before: "try insert something in another transaction"
    message_after: "successfully insert"
    timeout: 5
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (100)"
    message_before: "try insert something in another transaction"
    message_after: "successfully insert"
    timeout: 5
  - connection: "conn1"
    type: "exec"
    sql: "rollback"
    timeout: 5
  - connection: "conn1"
    type: "exec"
    sql: "insert into users(user_id) values (300),(301),(302),(303),(304)"
    message_before: "insert some new data"
    message_after: "successfully insert"
    timeout: 5
  - connection: "conn1"
    type: "exec"
    sql: "BEGIN"
    message_before: "lock some value in sequential"
    timeout: 5
  - connection: "conn1"
    type: "exec"
    sql: "select * from users where user_id=302 for update"
    timeout: 5
    async: true
    message_before: "gap lock on values [301,303)"
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (302)"
    message_before: "try insert something in another transaction"
    timeout: 5
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (303)"
    message_before: "try insert something in another transaction"
    message_after: "successfully insert"
    timeout: 5
  - connection: "conn2"
    type: "exec"
    sql: "insert into users(user_id) values (301)"
    message_before: "try insert something in another transaction"
    timeout: 5